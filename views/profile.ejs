<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Profile</title>

  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <style>
    body {
      background: #000;
    }

    .card-glass {
      background: rgba(30,30,30,0.22);
      border: 1.5px solid rgba(255,255,255,0.15);
      box-shadow: 0 4px 32px rgba(0,0,0,0.25);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
    }
    .card-glass:hover {
      background: rgba(50,50,50,0.3);
      border-color: rgba(255,255,255,0.28);
      box-shadow: 0 8px 36px rgba(0,0,0,0.28);
    }
  </style>
</head>

<body class="text-white">
  <%- include('partials/header', { user: user }) %>

  <% const displayed = profileUser || user; %>

  <div class="max-w-7xl mx-auto p-4 md:p-6 grid grid-cols-1 md:grid-cols-4 gap-8 mt-6">

    <!-- LEFT SIDEBAR -->
    <div class="col-span-1 md:sticky md:top-24 md:h-fit">

      <div class="card-glass p-6 rounded-2xl text-center">

        <img 
          src="<%= displayed.profile || '/profile/defaultProfile.png' %>"
          class="w-40 h-40 rounded-full mx-auto mb-4 object-cover border-4 border-white/20"
        />

        <div class="text-2xl font-bold"><%= displayed.name %></div>

        <div class="text-zinc-400 mt-1 mb-4">
          Joined <%= new Date(displayed.createdAt).toLocaleDateString() %>
        </div>

        <% if (!profileUser) { %>
          <form action="/profile/upload" method="post" enctype="multipart/form-data">
            <input type="file" name="profile" accept="image/*" class="hidden" id="profileUploadInput" onchange="this.form.submit()" />

            <label for="profileUploadInput"
              class="cursor-pointer bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-xl font-semibold inline-block">
              Upload Photo
            </label>
          </form>
        <% } %>

      </div>

    </div>

    <!-- RIGHT SIDE -->
    <div class="col-span-1 md:col-span-3">

      <!-- CREATE POST (Feed style) -->
      <form action="/post" method="POST" class="flex flex-row gap-2 w-full mb-8 items-center">
        <textarea
          name="content"
          placeholder="Post anything..."
          class="outline-none bg-black flex-1 px-3 py-3 text-white rounded-lg text-base placeholder-gray-400 border-2 border-zinc-500 focus:border-blue-400 focus:ring-2 focus:ring-blue-300 resize-none"
          rows="2"
          style="min-width: 0; box-shadow:none; border-width:2px; border-color:#71717a;"
        ></textarea>
        <button
          type="submit"
          class="flex items-center gap-2 px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white font-semibold transition"
          style="box-shadow:none;"
        >
          Post
        </button>
      </form>

      <h2 class="text-2xl font-semibold mb-5">Posts</h2>

      <% const posts = displayed.posts || []; %>

      <% if (posts.length === 0) { %>
        <div class="text-zinc-400">No posts yet.</div>
      <% } %>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6">

        <% posts.forEach(function(post) { %>

          <div class="card-glass p-4 rounded-2xl flex flex-col">

            <% if (editPostId && editPostId === String(post._id) && (!profileUser || String(profileUser._id) === String(user._id))) { %>

              <form action="/posts/<%= post._id %>/edit" method="post" class="flex flex-col gap-3">
                <textarea
                  name="content"
                  class="w-full p-3 rounded-xl bg-zinc-800 text-white border border-white/10"
                  rows="4"
                ><%= post.content %></textarea>

                <div class="flex gap-2">
                  <button class="bg-blue-600 px-4 py-2 rounded-xl">Save</button>
                  <a href="/profile" class="bg-zinc-600 px-4 py-2 rounded-xl">Cancel</a>
                </div>
              </form>

            <% } else { %>

              <div class="text-white/95 text-lg mb-2 break-words">
                <%= post.content %>
              </div>

              <!-- CREATED TIME -->
              <div class="text-xs text-zinc-400 mb-4">
                <%= new Date(post.createdAt).toLocaleString() %>
              </div>

              <div class="flex items-center gap-3 mt-auto">

                <form action="/posts/<%= post._id %>/like" method="post">
                  <% const liked = (post.likes || []).map(l => String(l)).includes(String(user._id)); %>
                  <button class="p-1 transition transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg"
                      class="w-6 h-6 <%= liked ? 'text-pink-400' : 'text-blue-400' %>"
                      fill="<%= liked ? 'currentColor' : 'none' %>"
                      viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 21s-6.716-4.867-9.447-9.086C.976 9.818 1.508 6.39 4.21 4.821A5.38 5.38 0 0 1 12 6.04a5.38 5.38 0 0 1 7.79-1.219c2.701 1.569 3.234 4.997 1.657 7.093C18.716 16.133 12 21 12 21Z"/>
                    </svg>
                  </button>
                </form>

                <span class="text-xs text-white ml-1"><%= post.likes.length %></span>

                <% if (String(post.author) === String(user._id)) { %>

                  <a href="/posts/<%= post._id %>/edit"
                    class="ml-auto p-1 transition transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg"
                      class="w-5 h-5 text-yellow-400"
                      fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16.862 4.487l1.651-1.652a2.1 2.1 0 113 3L11.25 16.1l-4 1 1-4L16.862 4.487z"/>
                    </svg>
                  </a>

                  <form action="/posts/<%= post._id %>/delete" method="post" class="inline">
                    <button class="p-1 transition transform hover:scale-110">
                      <svg xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5 text-pink-400"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 7h12m-1 0l-.867 12.142A2 2 0 0114.138 21H9.862a2 2 0 01-1.995-1.858L7 7m5-4h-1a2 2 0 00-2 2v2h6V5a2 2 0 00-2-2z"/>
                      </svg>
                    </button>
                  </form>

                <% } %>

              </div>

            <% } %>

          </div>

        <% }); %>

      </div>

    </div>
  </div>

</body>
</html>
