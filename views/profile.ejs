<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <title>Profile</title>
</head>
<body class="text-white min-h-screen bg-zinc-900">
  <div class="w-full max-w-4xl mx-auto pt-10 px-4">
    <!-- Top bar -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <div class="font-semibold text-xl">Welcome, <%= user.name %>!</div>
        <div class="text-zinc-300 text-sm">Name: <span class="font-medium"><%= user.name %></span></div>
        <div class="text-zinc-400 text-xs">Member since <%= new Date(user.createdAt).toLocaleDateString() %></div>
      </div>
      <form action="/logout" method="get">
        <button type="submit" class="bg-red-600 hover:bg-red-700 cursor-pointer text-white font-semibold py-2 px-6 rounded-md transition">Logout</button>
      </form>
    </div>

    <!-- Post form -->
    <div class="mb-10">
      <form action="/post" method="post" class="flex gap-3 items-center">
        <input name="content" type="text" required placeholder="What's on your mind?" class="px-4 py-2 rounded-md bg-zinc-700 text-white border border-zinc-600 flex-1 placeholder:text-zinc-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" />
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-md transition">Post</button>
      </form>
    </div>

    <!-- Posts -->
    <div class="flex flex-wrap gap-6 justify-start items-stretch">
      <% if (!user.posts || user.posts.length === 0) { %>
        <div class="w-full text-center text-zinc-400 text-lg">No posts yet.</div>
      <% } else { %>
        <% user.posts.forEach(function(post) { %>
          <div class="bg-zinc-800 rounded-lg shadow-lg flex flex-col gap-2 p-5 min-w-[260px] max-w-xs w-full">
            <div class="flex items-center mb-2">
              <span class="text-blue-400 font-semibold text-sm mr-2">@<%= user.name.replace(/\s+/g, '').toLowerCase() %></span>
            </div>

            <% if (editPostId && editPostId === String(post._id)) { %>
              <form action="/posts/<%= post._id %>/edit" method="post" class="flex flex-col gap-2">
                <textarea name="content" rows="2" class="w-full rounded bg-zinc-700 text-white px-2 py-1"><%= post.content %></textarea>
                <div class="flex gap-2">
                  <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded transition">Save</button>
                  <a href="/profile" class="bg-zinc-600 hover:bg-zinc-700 text-white text-xs px-3 py-1 rounded transition">Cancel</a>
                </div>
              </form>
            <% } else { %>
              <div class="font-semibold text-lg mb-2 break-words"><%= post.content %></div>
            <% } %>

            <div class="flex justify-between items-center">
              <div class="text-zinc-400 text-xs">
                Posted at 
                <% if (post.createdAt) { %>
                  <%= new Date(post.createdAt).toLocaleString() %>
                <% } else { %>
                  just now
                <% } %>
              </div>

              <div class="flex gap-2">
                <% 
                  // safe check: convert likes to string array
                  const likesArr = (post.likes || []).map(l => String(l));
                  const userLiked = likesArr.includes(String(user._id));
                  const likeCount = likesArr.length;
                %>

                <form action="/posts/<%= post._id %>/like" method="POST" class="inline">
                  <button type="submit" class="<%= userLiked ? 'bg-red-600' : 'bg-blue-600' %> hover:bg-blue-700 text-white text-xs px-3 py-1 rounded transition">
                    ❤️ <%= likeCount %> <%= likeCount === 1 ? 'Like' : 'Likes' %>
                  </button>
                </form>

                <% if (String(post.author) === String(user._id)) { %>

                    <a href="/posts/<%= post._id %>/edit" 
                       class="bg-yellow-600 hover:bg-yellow-700 text-white text-xs px-3 py-1 rounded transition">
                       Edit
                    </a>
                  
                    <form action="/posts/<%= post._id %>/delete" method="POST" class="inline">
                      <button type="submit"
                        class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded transition">
                        Delete
                      </button>
                    </form>
                  
                  <% } %>                 
              </div>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>
</body>
</html>
